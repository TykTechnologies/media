"use strict";var _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e};!function(e){"function"==typeof define&&define.amd?define(["jquery"],e):e("object"===("undefined"==typeof exports?"undefined":_typeof(exports))?require("jquery"):jQuery)}(function(e){function t(e){return e.split(".").pop()}function i(e){switch(t(e).toLowerCase()){case"jpg":case"gif":case"bmp":case"png":case"jpeg":case"svg":return!0}return!1}function a(t,i){this.$element=e(t),this.options=e.extend({},a.DEFAULTS,e.isPlainObject(i)&&i),this.init()}var n=e("body"),s=e(document),o="qor.medialibrary.select",r="click."+o,d=".qor-field__mediabox-list",l=".qor-field__mediabox-item",c=".qor-field__mediabox-data";return a.prototype={constructor:a,init:function(){var e=this.$element;this.SELECT_MEDIABOX_UNDO_TEMPLATE=e.find('[name="media-box-undo-delete"]').html(),this.bind(),this.initSelectedMedia()},bind:function(){s.on("reload.qor.bottomsheets",".qor-bottomsheets__mediabox",this.reloadData.bind(this)),this.$element.on(r,"[data-mediabox-url]",this.openBottomSheets.bind(this)).on(r,".qor-cropper__toggle--delete",this.deleteSelected.bind(this)).on(r,".qor-cropper__toggle--undo",this.undoDeleteSelected.bind(this)).on("change.qor.cropper","textarea.qor-file__options",this.imageCrop.bind(this))},deleteSelected:function(t){var i=e(t.target);return i.closest(l).addClass("is_deleted").append(this.SELECT_MEDIABOX_UNDO_TEMPLATE).find(".qor-file__list").hide(),this.updateMediaLibraryData(i.closest(d)),this.$element.find(c).data("isDeleted",!0),!1},undoDeleteSelected:function(t){var i=e(t.target);return i.closest(l).removeClass("is_deleted").find(".qor-file__list").show(),this.updateMediaLibraryData(i.closest(d)),i.closest(".qor-fieldset__alert").remove(),this.$element.find(c).data("isDeleted",!1),!1},imageCrop:function(t){var i=e(t.target).closest(l);this.syncImageCrop(i)},openBottomSheets:function(t){var i,a=e(t.target).closest("[data-mediabox-url]"),s=a.data();s.isDisabled||(this.BottomSheets=n.data("qor.bottomsheets"),this.bottomsheetsData=s,this.$parent=i=a.closest(".qor-field__mediabox"),this.$selectFeild=i.find(d),s.url=s.mediaboxUrl,this.SELECT_MANY_SELECTED_ICON=e('[name="select-many-selected-icon"]').html(),this.SELECT_MANY_HINT=e('[name="select-many-hint"]').html(),this.SELECT_MEDIABOX_TEMPLATE=i.find('[name="media-box-template"]').html(),this.SELECT_MEDIABOX_FILE_TEMPLATE=i.find('[name="media-box-file-template"]').html(),this.SELECT_MEDIABOX_UNDO_TEMPLATE=i.find('[name="media-box-undo-delete"]').html(),this.BottomSheets.open(s,this.handleSelectMany.bind(this)))},initSelectedMedia:function(){var e,t=this.$element,i=t.find(l),a=JSON.parse(t.find(c).val());if(a)for(var n=0;n<a.length;n++)e=i.filter('[data-primary-key="'+a[n].ID+'"]'),e.data().description||e.data("description",a[n].Description)},initMedia:function(){var t,i,a,n=this.$selectFeild,s=n.find(l).not(".is_deleted"),o=this.$bottomsheets.find("tbody tr"),r=this;s.each(function(){a=e(this).data().primaryKey,t=o.filter('[data-primary-key="'+a+'"]').addClass("is_selected"),r.changeIcon(t,!0)}),o.each(function(){t=e(this),i=t.find(".qor-table--ml-slideout p img").first(),t.find(".qor-table__actions").remove(),i.length&&(t.find(".qor-table--medialibrary-item").css("background-image","url("+i.prop("src")+")"),i.parent().remove())}),"1"!=this.bottomsheetsData.maxItem&&this.updateHint(this.getSelectedItemData())},reloadData:function(){this.$selectFeild&&this.initMedia()},renderSelectMany:function(e){return window.Mustache.render(this.SELECT_MEDIABOX_TEMPLATE,e)},renderHint:function(e){return window.Mustache.render(this.SELECT_MANY_HINT,e)},getSelectedItemData:function(t){var i,a=t||this.$selectFeild,n=a.find(l).not(".is_deleted"),s=[];return n.size()&&n.each(function(){i=e(this).data(),s.push({ID:i.primaryKey,Url:i.originalUrl.replace(/.original.(\w+)$/,".$1"),Description:i.description,FileName:i.fileName})}),{files:s,selectedNum:s.length}},updateHint:function(t){var i;e.extend(t,this.bottomsheetsData),i=this.renderHint(t),e(".qor-selectmany__hint").remove(),this.$bottomsheets.find(".qor-page__body").before(i)},updateMediaLibraryData:function(e,t){var i=e?e.find(c):this.$selectFeild.find(c),a=this.getSelectedItemData(e);i.val(JSON.stringify(a.files)).data("mediaData",t).trigger("changed.medialibrary",[t])},changeIcon:function(t,i){var a=t.find(".qor-table--medialibrary-item"),n=a.size()?a:t.find("td:first");t.find(".qor-select__select-icon").remove(),i&&("one"==i&&e(".qor-bottomsheets__mediabox").find(".qor-select__select-icon").remove(),n.prepend(this.SELECT_MANY_SELECTED_ICON))},syncImageCrop:function(t,i){var a,n,s=JSON.parse(t.find("textarea.qor-file__options").val()),o=t.data().mediaLibraryUrl,r={},d=["Width","Height"],l=t.find("img[data-size-name]");delete s.ID,delete s.Url,s.Sizes={},l.each(function(){n=e(this).data(),s.Sizes[n.sizeName]={};for(var t=0;t<d.length;t++)a=n["sizeResolution"+d[t]],a||(a=n.sizeResolution[d[t]]),s.Sizes[n.sizeName][d[t]]=a}),r.MediaOption=JSON.stringify(s),e.ajax({type:"PUT",url:o,data:JSON.stringify(r),contentType:"application/json",dataType:"json",success:function(a){r.MediaOption=JSON.parse(a.MediaOption),i&&e.isFunction(i)&&i(r,t)}})},showHiddenItem:function(e){e.removeClass("is_deleted").find(".qor-file__list").show(),e.find(".qor-fieldset__alert").remove()},removeItem:function(e){var t=e.primaryKey;this.$selectFeild.find('[data-primary-key="'+t+'"]').remove(),this.changeIcon(e.$clickElement)},compareCropSizes:function(e){var t,i,a=e.MediaOption.CropOptions,n=this.bottomsheetsData.cropSizes;if(!n)return!1;if(n=n.split(","),t=n.length-1,!window._.isObject(a))return!1;if(i=Object.keys(a),i.length)for(var s=0;s<t;s++)if(-1==i.indexOf(n[s]))return!0;return!1},addItem:function(t,a){var n=e(this.renderSelectMany(t)),s=n.find(".qor-file__input"),o=s.closest(l),r=this.$selectFeild.find('[data-primary-key="'+t.primaryKey+'"]'),d=this.bottomsheetsData.maxItem,c=this.getSelectedItemData().selectedNum,h=t.MediaOption.CropOptions,m=this.compareCropSizes(t),f=t.MediaOption.FileName,u=i(f),p=/.svg$/.test(t.MediaOption.FileName),b=this;if(a||(1==d?this.changeIcon(t.$clickElement,"one"):this.changeIcon(t.$clickElement,!0)),d&&c>=d){if(1!=d)return void window.alert(this.bottomsheetsData.maxItemHint);this.$selectFeild.find(l).remove()}if(r.size())return this.showHiddenItem(r),void(1==d&&setTimeout(function(){b.$bottomsheets.remove()},1e3));1==d&&this.$selectFeild.find(l).filter(".is_deleted").remove(),u||(n=e(window.Mustache.render(this.SELECT_MEDIABOX_FILE_TEMPLATE,t))),n.data({description:t.MediaOption.Description,mediaData:t}),p&&n.addClass("is-svg").find(".qor-file__input").remove(),n.appendTo(this.$selectFeild),h&&this.resetImages(t,n),n.find("textarea.qor-file__options").val(JSON.stringify(t.MediaOption)),n.trigger("enable"),h&&!m||!s.data("qor.cropper")||p||s.data("qor.cropper").load(t.MediaOption.URL,function(){b.syncImageCrop(o,b.resetImages)}),(a||1==d)&&setTimeout(function(){b.$bottomsheets.remove()},150)},resetImages:function(t,i){var a=t.MediaOption.CropOptions,n=Object.keys(a),s=t.MediaOption.OriginalURL;if(/original/.test(s)){for(var o=n.length-1;o>=0;o--)a[n[o]].URL=s.replace(/original/,n[o]);i.find("img").each(function(){var t=e(this),i=t.data().sizeName;i&&"original"!=i&&a[i]&&t.prop("src",a[i].URL)})}},handleSelectMany:function(e){var t={onSelect:this.onSelectResults.bind(this),onSubmit:this.onSubmitResults.bind(this)};e.qorSelectCore(t).addClass("qor-bottomsheets__mediabox"),this.$bottomsheets=e,this.initMedia()},onSelectResults:function(e){this.handleResults(e)},onSubmitResults:function(e){this.handleResults(e,!0)},handleResults:function(e,t){t?(e.MediaOption=JSON.parse(e.MediaOption),this.handleResultsData(e,t)):this.handleResultsData(e)},handleResultsData:function(e,t){var i,a=e.$clickElement;if(e.mediaLibraryUrl||t||(e.mediaLibraryUrl=e.url),t)return e.mediaLibraryUrl=this.bottomsheetsData.mediaboxUrl+"/"+e.primaryKey,this.addItem(e,t),void this.updateDatas(e);a.toggleClass("is_selected"),i=a.hasClass("is_selected"),i?this.addItem(e):this.removeItem(e),this.updateDatas(e)},updateDatas:function(e){"1"!=this.bottomsheetsData.maxItem&&this.updateHint(this.getSelectedItemData()),this.updateMediaLibraryData(null,e)}},a.plugin=function(t){return this.each(function(){var i,n=e(this),s=n.data(o);if(!s){if(/destroy/.test(t))return;n.data(o,s=new a(this,t))}"string"==typeof t&&e.isFunction(i=s[t])&&i.apply(s)})},e(function(){var t='[data-toggle="qor.mediabox"]';e(document).on("disable.qor.medialibrary.select",function(i){a.plugin.call(e(t,i.target),"destroy")}).on("enable.qor.medialibrary.select",function(i){a.plugin.call(e(t,i.target))}).triggerHandler("enable.qor.medialibrary.select")}),a});