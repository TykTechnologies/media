"use strict";!function(i){i.add("plugin","table",{translations:{en:{table:"Table","insert-table":"Insert table","insert-row-above":"Insert row above","insert-row-below":"Insert row below","insert-column-left":"Insert column left","insert-column-right":"Insert column right","add-head":"Add head","delete-head":"Delete head","delete-column":"Delete column","delete-row":"Delete row","delete-table":"Delete table","set-table-theme":"Set table theme","merge-cell":"Merge cell"}},modals:{setTableThemeModal:'<form action=""></form>'},onmodal:{setTableThemeModal:{open:function(e,t){if(!this.opts.setTableThemeModal&&void 0!==this.opts.tableClassNames){var a=this.opts.tableClassNames.split(";").reduce(function(e,t){var a=t.split(",");if(a&&2===a.length){var o=a[1];return e+'<option value="'+a[0]+'">'+o+"</option>"}},"");a='<option value="">No Theme</option>'+a,this.opts.setTableThemeModal='<div class="form-item"><label>Select Theme</label><select name="theme">'+a+"\n            </select></div>"}t.append(this.opts.setTableThemeModal)},save:function(e,t){var a=t.getData();a&&null!=a.theme&&this.app.api("plugin.table.setTableTheme",{classValue:a.theme})}}},init:function(e){this.app=e,this.lang=e.lang,this.opts=e.opts,this.caret=e.caret,this.editor=e.editor,this.toolbar=e.toolbar,this.component=e.component,this.inspector=e.inspector,this.insertion=e.insertion,this.selection=e.selection,this.block=e.block},ondropdown:{table:{observe:function(e){this._observeDropdown(e)}}},onbottomclick:function(){this.insertion.insertToEnd(this.editor.getLastNode(),"table")},start:function(){var e={observe:"table","insert-table":{title:this.lang.get("insert-table"),api:"plugin.table.insert"},"insert-row-above":{title:this.lang.get("insert-row-above"),classname:"redactor-table-item-observable",api:"plugin.table.addRowAbove"},"insert-row-below":{title:this.lang.get("insert-row-below"),classname:"redactor-table-item-observable",api:"plugin.table.addRowBelow"},"insert-column-left":{title:this.lang.get("insert-column-left"),classname:"redactor-table-item-observable",api:"plugin.table.addColumnLeft"},"insert-column-right":{title:this.lang.get("insert-column-right"),classname:"redactor-table-item-observable",api:"plugin.table.addColumnRight"},"add-head":{title:this.lang.get("add-head"),classname:"redactor-table-item-observable",api:"plugin.table.addHead"},"delete-head":{title:this.lang.get("delete-head"),classname:"redactor-table-item-observable",api:"plugin.table.deleteHead"},"delete-column":{title:this.lang.get("delete-column"),classname:"redactor-table-item-observable",api:"plugin.table.deleteColumn"},"delete-row":{title:this.lang.get("delete-row"),classname:"redactor-table-item-observable",api:"plugin.table.deleteRow"},"delete-table":{title:this.lang.get("delete-table"),classname:"redactor-table-item-observable",api:"plugin.table.deleteTable"},"merge-cell":{title:this.lang.get("merge-cell"),classname:"redactor-table-item-observable",api:"plugin.table.mergeCell"}};this.opts.tableClassNames="table-asics-blue,ASICS Blue;table-asics-light-blue,ASICS Light Blue;table-asics-light-green,ASICS Light Green;table-asics-coral,ASICS Carol",void 0!==this.opts.tableClassNames&&(e["set-table-theme"]={title:this.lang.get("set-table-theme"),classname:"redactor-table-item-observable",api:"plugin.table.setTableThemeModal"});var t={title:this.lang.get("table")},a=this.toolbar.addButtonBefore("link","table",t);a.setIcon('<i class="re-icon-table"></i>'),a.setDropdown(e);var o,n,i=!1,l=$(this.app.editor.$editor.nodes[0]);l.on("focus","td,th",function(){l.find("td[data-active],th[data-active]").removeAttr("data-active"),$(this).attr("data-active",""),n=$(o=this).closest("thead,tbody")}),$("body").on("click",function(e){var t=0<$(e.target).closest("table").length,a=0<$(e.target).closest(".redactor-toolbar").length,o=0<$(e.target).closest(".redactor-dropdown").length;t||a||o||l.find("td[data-active],th[data-active]").removeAttr("data-active")}),l.on("mousedown","td, th",function(){i=!!1;var e=$(this).closest("thead,tbody");s.calcTableElementPosition(e)}),l.on("mouseup","td, th",function(){i=!!0,console.log("show context bar")});var s=this;l.on("mouseenter","td, th",function(){var e=$(this).closest("thead,tbody");i&&e[0]===n[0]&&(e.find("td[data-active],th[data-active]").removeAttr("data-active"),s.calcCellMergeRange(o,this),s.renderCellMergeRange(s.finalRange))})},calcCellMergeRange:function(e,t){var u=this,a={firstPoint:JSON.parse(e.firstPoint),lastPoint:JSON.parse(e.lastPoint)},o={firstPoint:JSON.parse(t.firstPoint),lastPoint:JSON.parse(t.lastPoint)},n=Math.min(a.firstPoint.row,a.lastPoint.row,o.firstPoint.row,o.lastPoint.row),i=Math.min(a.firstPoint.col,a.lastPoint.col,o.firstPoint.col,o.lastPoint.col),l=Math.max(a.firstPoint.row,a.lastPoint.row,o.firstPoint.row,o.lastPoint.row),s=Math.max(a.firstPoint.col,a.lastPoint.col,o.firstPoint.col,o.lastPoint.col);u.finalRange=function e(t,a,o,n){for(var i=t,l=a,s=o,r=n,d=t;d<=o;d++)for(var c=a;c<=n;c++){var h=u.tableElements[d][c],m=JSON.parse(h.firstPoint),b=JSON.parse(h.lastPoint);i=Math.min(parseInt(m.row),parseInt(b.row),i),l=Math.min(m.col,b.col,l),s=Math.max(m.row,b.row,s),r=Math.max(m.col,b.col,r)}return i==t&&l==a&&s==o&&r==n?{minRow:t,minCol:a,maxRow:o,maxCol:n}:e(i,l,s,r)}(n,i,l,s),u.selectedRowRange=l-n+1,u.selectedColRange=s-i+1},renderCellMergeRange:function(e){for(var t=e.minRow,a=e.minCol,o=e.maxRow,n=e.maxCol,i=t;i<=o;i++)for(var l=a;l<=n;l++){var s=this.tableElements[i][l];$(s).attr("data-active","")}},savePosition:function(e,t){e.lastPoint||(e.firstPoint=t),e.lastPoint=t},calcTableElementPosition:function(e){var d=this;function n(e,t,a,o,n){for(var i=parseInt(t)+parseInt(o),l=parseInt(n)+parseInt(a),s=t;s<i;s++)for(var r=a;r<l;r++)d.tableElements[s]=d.tableElements[s]||[],d.tableElements[s][r]=e}this.tableElements=[],e.find("tr").each(function(a){var e=$(this);d.tableElements[a]=d.tableElements[a]||[];var o=0;e.find("td,th").each(function(){var e=$(this).attr("rowspan")||1,t=$(this).attr("colspan")||1;d.tableElements[a][o]?(o=d.tableElements[a].length,d.tableElements[a].push(this),(1<e||1<t)&&n(this,a,o,e,t)):1<e||1<t?n(this,a,o,e,t):d.tableElements[a][o]=this,o++}),d.tableElements.forEach(function(e,a){e.forEach(function(e,t){d.savePosition(e,JSON.stringify({row:a,col:t}))})})})},insert:function(){var e=this.component.create("table");e.$element.addClass("table-asics-richeditor");for(var t=0;t<2;t++)e.addRow(3);e=this.insertion.insertHtml(e),this.caret.setStart(e)},addRowAbove:function(){var e=this._getComponent();if(e){var t=this.selection.getCurrent(),a=e.addRowTo(t,"before");this.caret.setStart(a)}},addRowBelow:function(){var e=this._getComponent();if(e){var t=this.selection.getCurrent(),a=e.addRowTo(t,"after");this.caret.setStart(a)}},addColumnLeft:function(){var e=this._getComponent();if(e){var t=this.selection.getCurrent();this.selection.save(),e.addColumnTo(t,"left"),this.selection.restore()}},addColumnRight:function(){var e=this._getComponent();if(e){var t=this.selection.getCurrent();this.selection.save(),e.addColumnTo(t,"right"),this.selection.restore()}},addHead:function(){var e=this._getComponent();e&&(this.selection.save(),e.addHead(),this.selection.restore())},deleteHead:function(){var e=this._getComponent();if(e){var t=this.selection.getCurrent();0!==i.dom(t).closest("thead").length?(e.removeHead(),this.caret.setStart(e)):(this.selection.save(),e.removeHead(),this.selection.restore())}},deleteColumn:function(){var e=this._getComponent();if(e){var t=this.selection.getCurrent(),a=i.dom(t).closest("td, th"),o=a.nextElement().get(),n=a.prevElement().get();e.removeColumn(t),o?this.caret.setStart(o):n?this.caret.setEnd(n):this.deleteTable()}},deleteRow:function(){var e=this._getComponent();if(e){var t=this.selection.getCurrent(),a=i.dom(t).closest("tr"),o=a.nextElement().get(),n=a.prevElement().get();e.removeRow(t),o?this.caret.setStart(o):n?this.caret.setEnd(n):this.deleteTable()}},mergeCell:function(){var e=this;if(this._getTable()&&this._getComponent()){var t=this.selection.getCurrent(),a=$(t).closest("tbody,thead"),o=e.finalRange,n=o.minRow,i=o.minCol,l=o.maxRow,s=o.maxCol,r=$(e.tableElements[n][i]),d=r.attr("rowspan")||1,c=r.attr("colspan")||1;d=Math.max(d-1,e.selectedRowRange),r.attr("rowspan",d),c=Math.max(c-1,e.selectedColRange),r.attr("colspan",c);for(var h=n;h<=l;h++)for(var m=i;m<=s;m++){var b=e.tableElements[h][m];b!=r[0]&&$(b).remove(),e.tableElements[h][m]=r[0],e.savePosition(a[0],JSON.stringify({x:h,y:m}))}}},deleteTable:function(){var e=this._getTable();e&&this.component.remove(e)},clearTableTheme:function(){var e=this._getTable();e&&i.dom(e).removeClass(this.opts.tableClassNames.toString().replace(/[,;]/g," "))},setTableTheme:function(e){var t=this._getTable();t&&(this.clearTableTheme(),i.dom(t).addClass(e.classValue),this.app.api("module.modal.close"))},setTableThemeModal:function(){this.app.api("module.modal.build",{name:"setTableThemeModal",title:"Set table theme",handle:"save",commands:{save:{title:"Save"},cancel:{title:"Cancel"}}})},_getTable:function(){var e=this.selection.getCurrent(),t=this.inspector.parse(e);if(t.isTable())return t.getTable()},_getComponent:function(){var e=this.selection.getCurrent(),t=this.inspector.parse(e);if(t.isTable()){var a=t.getTable();return this.component.create("table",a)}},_observeDropdown:function(e){var t=this._getTable(),a=e.getItemsByClass("redactor-table-item-observable"),o=e.getItem("insert-table");t?(this._observeItems(a,"enable"),o.disable()):(this._observeItems(a,"disable"),o.enable())},_observeItems:function(e,t){for(var a=0;a<e.length;a++)e[a][t]()}})}(Redactor),function(l){l.add("class","table.component",{mixins:["dom","component"],init:function(e,t){return this.app=e,t&&void 0!==t.cmnt?t:this._init(t)},addHead:function(){this.removeHead();var e=this.$element.find("tr").first().children("td, th").length,t=l.dom("<thead>"),a=this._buildRow(e,"<th>");t.append(a),this.$element.prepend(t)},addRow:function(e){var t=this._buildRow(e);return this.$element.append(t),t},addRowTo:function(e,t){return this._addRowTo(e,t)},addColumnTo:function(e,n){var t=l.dom(e),a=t.closest("tr"),o=t.closest("td, th"),i=0;a.find("td, th").each(function(e,t){e===o.get()&&(i=t)}),this.$element.find("tr").each(function(e){var t=l.dom(e).find("td, th").get(i),a=l.dom(t),o=a.clone();o.html(""),"right"===n?a.after(o):a.before(o)})},removeHead:function(){var e=this.$element.find("thead");0!==e.length&&e.remove()},removeRow:function(e){l.dom(e).closest("tr").remove()},removeColumn:function(e){var t=l.dom(e),a=t.closest("tr"),o=t.closest("td, th"),n=0;a.find("td, th").each(function(e,t){e===o.get()&&(n=t)}),this.$element.find("tr").each(function(e){var t=l.dom(e).find("td, th").get(n);l.dom(t).remove()})},_init:function(e){var t,a;if(void 0!==e){var o=l.dom(e),n=o.get(),i=o.closest("figure");0!==i.length?a=(t=i).find("table").get():"TABLE"===n.tagName&&(a=n)}this._buildWrapper(t),this._buildElement(a),this._initWrapper()},_addRowTo:function(e,t){var a=l.dom(e).closest("tr");if(0!==a.length){var o=a.children("td, th").length,n=this._buildRow(o);return a[t](n),n}},_buildRow:function(e,t){t=t||"<td>";for(var a=l.dom("<tr>"),o=0;o<e;o++){var n=l.dom(t);n.attr("contenteditable",!0),a.append(n)}return a},_buildElement:function(e){e?this.$element=l.dom(e):(this.$element=l.dom("<table>"),this.append(this.$element))},_buildWrapper:function(e){e=e||"<figure>",this.parse(e)},_initWrapper:function(){this.addClass("redactor-component"),this.attr({"data-redactor-type":"table",tabindex:"-1",contenteditable:!1})}})}(Redactor);